import path from "path";
import { fileURLToPath } from "url";
import { promisify } from "util";
import connect from "connect";
import mime from "mime";
import { polyfill } from "@astropub/webapi";
import { performance } from "perf_hooks";
import stripAnsi from "strip-ansi";
import vite from "../vite.js";
import { defaultLogOptions, error, info } from "../logger.js";
import { ssr } from "../ssr/index.js";
import { STYLE_EXTENSIONS } from "../ssr/css.js";
import { collectResources } from "../ssr/html.js";
import { createRouteManifest, matchRoute } from "../ssr/routing.js";
import { createVite } from "../create-vite.js";
import * as msg from "./messages.js";
import notFoundTemplate, { subpathNotUsedTemplate } from "./template/4xx.js";
import serverErrorTemplate from "./template/5xx.js";
async function dev(config, options = { logging: defaultLogOptions }) {
  polyfill(globalThis, {
    exclude: "window document"
  });
  const server = new AstroDevServer(config, options);
  await server.start();
  process.on("SIGTERM", () => server.stop());
  return {
    hostname: server.hostname,
    port: server.port,
    server: server.app,
    stop: () => server.stop()
  };
}
class AstroDevServer {
  constructor(config, options) {
    this.app = connect();
    this.routeCache = {};
    this.config = config;
    this.hostname = config.devOptions.hostname || "localhost";
    this.logging = options.logging;
    this.port = config.devOptions.port;
    this.origin = `http://${this.hostname}:${this.port}`;
    this.site = config.buildOptions.site ? new URL(config.buildOptions.site) : void 0;
    this.devRoot = this.site ? this.site.pathname : "/";
    this.url = new URL(this.devRoot, this.origin);
    this.manifest = createRouteManifest({ config }, this.logging);
  }
  async start() {
    const devStart = performance.now();
    this.viteServer = await this.createViteServer();
    this.app.use(this.viteServer.middlewares);
    this.app.use((req, res, next) => this.handleRequest(req, res, next));
    this.app.use((req, res, next) => this.renderError(req, res, next));
    await this.listen(devStart);
  }
  async stop() {
    if (this.viteServer) {
      await this.viteServer.close();
    }
    if (this.httpServer) {
      await promisify(this.httpServer.close.bind(this.httpServer))();
    }
  }
  async handleHotUpdate({ file, modules }) {
    var _a;
    const { viteServer } = this;
    if (!viteServer)
      throw new Error(`AstroDevServer.start() not called`);
    for (const module of modules) {
      viteServer.moduleGraph.invalidateModule(module);
    }
    const route = this.mostRecentRoute;
    const [pathname, search = void 0] = ((_a = route == null ? void 0 : route.pathname) != null ? _a : "/").split("?");
    if (!route) {
      viteServer.ws.send({
        type: "full-reload"
      });
      return [];
    }
    try {
      const filePath = new URL(`./${route.component}`, this.config.projectRoot);
      const html = await ssr({
        astroConfig: this.config,
        filePath,
        logging: this.logging,
        mode: "development",
        origin: this.origin,
        pathname,
        route,
        routeCache: this.routeCache,
        viteServer
      });
      let invalidatedModules = [];
      await Promise.all(collectResources(html).filter(({ href }) => {
        if (!href)
          return false;
        const ext = path.extname(href);
        return STYLE_EXTENSIONS.has(ext);
      }).map(async ({ href }) => {
        const viteModule = viteServer.moduleGraph.getModuleById(`${href}?direct`) || await viteServer.moduleGraph.getModuleByUrl(`${href}?direct`) || viteServer.moduleGraph.getModuleById(href) || await viteServer.moduleGraph.getModuleByUrl(href);
        if (viteModule) {
          invalidatedModules.push(viteModule);
          viteServer.moduleGraph.invalidateModule(viteModule);
        }
      }));
      viteServer.ws.send({
        type: "custom",
        event: "astro:reload",
        data: { html }
      });
      for (const viteModule of invalidatedModules) {
        setTimeout(() => {
          viteServer.ws.send({
            type: "update",
            updates: [
              {
                type: viteModule.type === "js" ? "js-update" : "css-update",
                path: viteModule.id || viteModule.file || viteModule.url,
                acceptedPath: viteModule.url,
                timestamp: Date.now()
              }
            ]
          });
        }, 150);
      }
      return [];
    } catch (e) {
      const err = e;
      console.error(err.stack);
      viteServer.ws.send({
        type: "full-reload"
      });
      return [];
    }
  }
  listen(devStart) {
    let showedPortTakenMsg = false;
    return new Promise((resolve, reject) => {
      const appListen = () => {
        var _a;
        this.httpServer = this.app.listen(this.port, this.hostname, () => {
          info(this.logging, "astro", msg.devStart({ startupTime: performance.now() - devStart }));
          info(this.logging, "astro", msg.devHost({ host: `http://${this.hostname}:${this.port}${this.devRoot}` }));
          resolve();
        });
        (_a = this.httpServer) == null ? void 0 : _a.on("error", onError);
      };
      const onError = (err) => {
        var _a;
        if (err.code && err.code === "EADDRINUSE") {
          if (!showedPortTakenMsg) {
            info(this.logging, "astro", msg.portInUse({ port: this.port }));
            showedPortTakenMsg = true;
          }
          this.port++;
          return appListen();
        } else {
          error(this.logging, "astro", err.stack);
          (_a = this.httpServer) == null ? void 0 : _a.removeListener("error", onError);
          reject(err);
        }
      };
      appListen();
    });
  }
  async createViteServer() {
    const viteConfig = await createVite(vite.mergeConfig({
      mode: "development",
      server: {
        middlewareMode: "ssr",
        host: this.hostname
      }
    }, this.config.vite || {}), { astroConfig: this.config, logging: this.logging, devServer: this });
    const viteServer = await vite.createServer(viteConfig);
    const pagesDirectory = fileURLToPath(this.config.pages);
    viteServer.watcher.on("add", (file) => {
      if (!file.startsWith(pagesDirectory)) {
        return;
      }
      this.routeCache = {};
      this.manifest = createRouteManifest({ config: this.config }, this.logging);
    });
    viteServer.watcher.on("unlink", (file) => {
      if (!file.startsWith(pagesDirectory)) {
        return;
      }
      this.routeCache = {};
      this.manifest = createRouteManifest({ config: this.config }, this.logging);
    });
    viteServer.watcher.on("change", () => {
      this.routeCache = {};
    });
    return viteServer;
  }
  async handleRequest(req, res, next) {
    if (!this.viteServer)
      throw new Error(`AstroDevServer.start() not called`);
    let [pathname, search = void 0] = (req.url || "/").split("?");
    const reqStart = performance.now();
    let filePath;
    try {
      let routePathname = pathname;
      if (this.devRoot !== "/") {
        if (pathname.startsWith(this.devRoot)) {
          routePathname = pathname.substr(this.devRoot.length) || "";
          if (!routePathname.startsWith("/")) {
            routePathname = "/" + routePathname;
          }
        } else {
          next();
          return;
        }
      }
      const route = matchRoute(routePathname, this.manifest);
      if (!route) {
        const newPathname = routePathname.startsWith("/") ? routePathname : "/" + routePathname;
        req.url = newPathname;
        next();
        return;
      }
      filePath = new URL(`./${route.component}`, this.config.projectRoot);
      const html = await ssr({
        astroConfig: this.config,
        filePath,
        logging: this.logging,
        mode: "development",
        origin: this.origin,
        pathname: routePathname,
        route,
        routeCache: this.routeCache,
        viteServer: this.viteServer
      });
      this.mostRecentRoute = route;
      info(this.logging, "astro", msg.req({ url: pathname, statusCode: 200, reqTime: performance.now() - reqStart }));
      res.writeHead(200, {
        "Content-Type": mime.getType(".html"),
        "Content-Length": Buffer.byteLength(html, "utf8")
      });
      res.write(html);
      res.end();
    } catch (err) {
      const statusCode = 500;
      await this.viteServer.moduleGraph.invalidateAll();
      this.viteServer.ws.send({ type: "error", err });
      let html = serverErrorTemplate({
        statusCode,
        title: "Internal Error",
        tabTitle: "500: Error",
        message: stripAnsi(err.message),
        url: err.url || void 0,
        stack: stripAnsi(err.stack)
      });
      html = await this.viteServer.transformIndexHtml(pathname, html, pathname);
      info(this.logging, "astro", msg.req({ url: pathname, statusCode: 500, reqTime: performance.now() - reqStart }));
      res.writeHead(statusCode, {
        "Content-Type": mime.getType(".html"),
        "Content-Length": Buffer.byteLength(html, "utf8")
      });
      res.write(html);
      res.end();
    }
  }
  async renderError(req, res, next) {
    if (!this.viteServer)
      throw new Error(`AstroDevServer.start() not called`);
    const pathname = req.url || "/";
    const reqStart = performance.now();
    let html = "";
    const statusCode = 404;
    const relPages = this.config.pages.href.replace(this.config.projectRoot.href, "");
    const userDefined404 = this.manifest.routes.find((route) => route.component === relPages + "404.astro");
    if (userDefined404) {
      html = await ssr({
        astroConfig: this.config,
        filePath: new URL(`./${userDefined404.component}`, this.config.projectRoot),
        logging: this.logging,
        mode: "development",
        pathname: `/${userDefined404.component}`,
        origin: this.origin,
        routeCache: this.routeCache,
        viteServer: this.viteServer
      });
    } else {
      if (pathname === "/" && !pathname.startsWith(this.devRoot)) {
        html = subpathNotUsedTemplate(this.devRoot, pathname);
      } else {
        html = notFoundTemplate({ statusCode, title: "Not found", tabTitle: "404: Not Found", pathname });
      }
    }
    info(this.logging, "astro", msg.req({ url: pathname, statusCode, reqTime: performance.now() - reqStart }));
    res.writeHead(statusCode, {
      "Content-Type": mime.getType(".html"),
      "Content-Length": Buffer.byteLength(html, "utf8")
    });
    res.write(html);
    res.end();
  }
}
export {
  AstroDevServer,
  dev as default
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vc3JjL2NvcmUvZGV2L2luZGV4LnRzIl0sCiAgIm1hcHBpbmdzIjogIkFBTUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBY0EsbUJBQWtDLFFBQXFCLFVBQXNCLEVBQUUsU0FBUyxxQkFBeUM7QUFFaEksV0FBUyxZQUFZO0FBQUEsSUFDcEIsU0FBUztBQUFBO0FBSVYsUUFBTSxTQUFTLElBQUksZUFBZSxRQUFRO0FBQzFDLFFBQU0sT0FBTztBQUdiLFVBQVEsR0FBRyxXQUFXLE1BQU0sT0FBTztBQUNuQyxTQUFPO0FBQUEsSUFDTixVQUFVLE9BQU87QUFBQSxJQUNqQixNQUFNLE9BQU87QUFBQSxJQUNiLFFBQVEsT0FBTztBQUFBLElBQ2YsTUFBTSxNQUFNLE9BQU87QUFBQTtBQUFBO0FBS2QscUJBQXFCO0FBQUEsRUFnQjNCLFlBQVksUUFBcUIsU0FBcUI7QUFmdEQsZUFBc0I7QUFVdEIsc0JBQXlCO0FBTXhCLFNBQUssU0FBUztBQUNkLFNBQUssV0FBVyxPQUFPLFdBQVcsWUFBWTtBQUM5QyxTQUFLLFVBQVUsUUFBUTtBQUN2QixTQUFLLE9BQU8sT0FBTyxXQUFXO0FBQzlCLFNBQUssU0FBUyxVQUFVLEtBQUssWUFBWSxLQUFLO0FBQzlDLFNBQUssT0FBTyxPQUFPLGFBQWEsT0FBTyxJQUFJLElBQUksT0FBTyxhQUFhLFFBQVE7QUFDM0UsU0FBSyxVQUFVLEtBQUssT0FBTyxLQUFLLEtBQUssV0FBVztBQUNoRCxTQUFLLE1BQU0sSUFBSSxJQUFJLEtBQUssU0FBUyxLQUFLO0FBQ3RDLFNBQUssV0FBVyxvQkFBb0IsRUFBRSxVQUFVLEtBQUs7QUFBQTtBQUFBLFFBR2hELFFBQVE7QUFDYixVQUFNLFdBQVcsWUFBWTtBQUc3QixTQUFLLGFBQWEsTUFBTSxLQUFLO0FBQzdCLFNBQUssSUFBSSxJQUFJLEtBQUssV0FB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
