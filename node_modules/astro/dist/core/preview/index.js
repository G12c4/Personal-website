import http from "http";
import { performance } from "perf_hooks";
import send from "send";
import { fileURLToPath } from "url";
import fs from "fs";
import * as msg from "../dev/messages.js";
import { error, info } from "../logger.js";
import { subpathNotUsedTemplate, notFoundTemplate } from "../dev/template/4xx.js";
import { appendForwardSlash, trimSlashes } from "../path.js";
async function preview(config, { logging }) {
  const startServerTime = performance.now();
  const pageUrlFormat = config.buildOptions.pageUrlFormat;
  const trailingSlash = config.devOptions.trailingSlash;
  const forceTrailingSlash = trailingSlash === "always";
  const blockTrailingSlash = trailingSlash === "never";
  const defaultFile = "index.html";
  const defaultOrigin = "http://localhost";
  const sendOptions = {
    extensions: pageUrlFormat === "file" ? ["html"] : false,
    index: false,
    root: fileURLToPath(config.dist)
  };
  let baseURL = new URL(appendForwardSlash(config.buildOptions.site || ""), defaultOrigin);
  const server = http.createServer((req, res) => {
    const requestURL = new URL(req.url, defaultOrigin);
    if (!requestURL.pathname.startsWith(baseURL.pathname)) {
      res.statusCode = 404;
      res.end(subpathNotUsedTemplate(baseURL.pathname, requestURL.pathname));
      return;
    }
    const pathname = requestURL.pathname.slice(baseURL.pathname.length - 1);
    const isRoot = pathname === "/";
    const hasTrailingSlash = isRoot || pathname.endsWith("/");
    let tryTrailingSlash = true;
    let tryHtmlExtension = true;
    let url;
    const onErr = (message) => {
      res.statusCode = 404;
      res.end(notFoundTemplate(pathname, message));
    };
    const onStat = (err, stat) => {
      switch (true) {
        case (err && tryHtmlExtension && hasTrailingSlash && !blockTrailingSlash):
        case (err && tryHtmlExtension && !hasTrailingSlash && !forceTrailingSlash && !pathname.endsWith(".html")):
          tryHtmlExtension = false;
          return fs.stat(url = new URL(url.pathname + ".html", url), onStat);
        case err !== null:
          return onErr("Path not found");
        case (stat.isDirectory() && hasTrailingSlash && blockTrailingSlash && !isRoot):
          return onErr("Prohibited trailing slash");
        case (stat.isDirectory() && !hasTrailingSlash && forceTrailingSlash && !isRoot):
          return onErr("Required trailing slash");
        case (stat.isDirectory() && tryTrailingSlash):
          tryTrailingSlash = false;
          return fs.stat(url = new URL(url.pathname + (url.pathname.endsWith("/") ? defaultFile : "/" + defaultFile), url), onStat);
        case stat.isDirectory():
          return onErr("Path not found");
        default:
          send(req, fileURLToPath(url), {
            extensions: false,
            index: false
          }).pipe(res);
      }
    };
    fs.stat(url = new URL(trimSlashes(pathname), config.dist), onStat);
  });
  let { hostname, port } = config.devOptions;
  let httpServer;
  function startServer(timerStart) {
    let showedPortTakenMsg = false;
    let showedListenMsg = false;
    return new Promise((resolve, reject) => {
      const listen = () => {
        httpServer = server.listen(port, hostname, () => {
          if (!showedListenMsg) {
            info(logging, "astro", msg.devStart({ startupTime: performance.now() - timerStart }));
            info(logging, "astro", msg.devHost({ host: `http://${hostname}:${port}${baseURL.pathname}` }));
          }
          showedListenMsg = true;
          resolve();
        });
        httpServer == null ? void 0 : httpServer.on("error", onError);
      };
      const onError = (err) => {
        if (err.code && err.code === "EADDRINUSE") {
          if (!showedPortTakenMsg) {
            info(logging, "astro", msg.portInUse({ port }));
            showedPortTakenMsg = true;
          }
          port++;
          return listen();
        } else {
          error(logging, "astro", err.stack);
          httpServer == null ? void 0 : httpServer.removeListener("error", onError);
          reject(err);
        }
      };
      listen();
    });
  }
  await startServer(startServerTime);
  return {
    hostname,
    port,
    server: httpServer,
    stop: async () => {
      httpServer.close();
    }
  };
}
export {
  preview as default
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vc3JjL2NvcmUvcHJldmlldy9pbmRleC50cyJdLAogICJtYXBwaW5ncyI6ICJBQUlBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQWNBLHVCQUFzQyxRQUFxQixFQUFFLFdBQW1EO0FBQy9HLFFBQU0sa0JBQWtCLFlBQVk7QUFDcEMsUUFBTSxnQkFBZ0IsT0FBTyxhQUFhO0FBQzFDLFFBQU0sZ0JBQWdCLE9BQU8sV0FBVztBQUN4QyxRQUFNLHFCQUFxQixrQkFBa0I7QUFDN0MsUUFBTSxxQkFBcUIsa0JBQWtCO0FBRzdDLFFBQU0sY0FBYztBQUVwQixRQUFNLGdCQUFnQjtBQUV0QixRQUFNLGNBQWM7QUFBQSxJQUNuQixZQUFZLGtCQUFrQixTQUFTLENBQUMsVUFBVTtBQUFBLElBQ2xELE9BQU87QUFBQSxJQUNQLE1BQU0sY0FBYyxPQUFPO0FBQUE7QUFJNUIsTUFBSSxVQUFVLElBQUksSUFBSSxtQkFBbUIsT0FBTyxhQUFhLFFBQVEsS0FBSztBQUcxRSxRQUFNLFNBQVMsS0FBSyxhQUFhLENBQUMsS0FBSyxRQUFRO0FBQzlDLFVBQU0sYUFBYSxJQUFJLElBQUksSUFBSSxLQUFlO0FBRzlDLFFBQUksQ0FBQyxXQUFXLFNBQVMsV0FBVyxRQUFRLFdBQVc7QUFDdEQsVUFBSSxhQUFhO0FBQ2pCLFVBQUksSUFBSSx1QkFBdUIsUUFBUSxVQUFVLFdBQVc7QUFDNUQ7QUFBQTtBQUlELFVBQU0sV0FBVyxXQUFXLFNBQVMsTUFBTSxRQUFRLFNBQVMsU0FBUztBQUVyRSxVQUFNLFNBQVMsYUFBYTtBQUM1QixVQUFNLG1CQUFtQixVQUFVLFNBQVMsU0FBUztBQUVyRCxRQUFJLG1CQUFtQjtBQUN2QixRQUFJLG1CQUFtQjtBQUV2QixRQUFJO0FBRUosVUFBTSxRQUFRLENBQUMsWUFBb0I7QUFDbEMsVUFBSSxhQUFhO0FBQ2pCLFVBQUksSUFBSSxpQkFBaUIsVUFBVTtBQUFBO0FBR3BDLFVBQU0sU0FBUyxDQUFDLEtBQW1DLFNBQWdCO0FBQ2xFLGNBQVE7QUFBQSxhQUVGLFFBQU8sb0JBQW9CLG9CQUFvQixDQUFDO0FBQUEsYUFDaEQsUUFBTyxvQkFBb0IsQ0FBQyxvQkFBb0IsQ0FBQyxzQkFBc0IsQ0FBQyxTQUFTLFNBQVM7QUFDOUYsNkJBQW1CO0FBQ25CLGlCQUFPLEdBQUcsS0FBTSxNQUFNLElBQUksSUFBSSxJQUFJLFdBQVcsU0FBUyxNQUFPO0FBQUEsYUFHekQsUUFBUTtBQUNaLGlCQUFPLE1BQU07QUFBQSxhQUdULE1BQUssaUJBQWlCLG9CQUFvQixzQkFBc0IsQ0FBQztBQUNyRSxpQkFBTyxNQUFNO0FBQUEsYUFHVCxNQUFLLGlCQUFpQixDQUFDLG9CQUFvQixzQkFBc0IsQ0FBQztBQUN0RSxpQkFBTyxNQUFNO0FBQUEsYUFHVCxNQUFLLGlCQUFpQjtBQUMxQiw2QkFBbUI7QUFDbkIsaUJBQU8sR0FBRyxLQUFNLE1BQU0sSUFBSSxJQUFJLElBQUksV0FBWSxLQUFJLFNBQVMsU0FBUyxPQUFPLGNBQWMsTUFBTSxjQUFjLE1BQU87QUFBQSxhQUdoSCxLQUFLO0FBQ1QsaUJBQU8sTUFBTTtBQUFBO0FBSWIsZUFBSyxLQUFLLGNBQWMsTUFBTTtBQUFBLFlBQzdCLFlBQVk7QUFBQSxZQUNaLE9BQU87QUFBQSxhQUNMLEtBQUs7QUFBQTtBQUFBO0FBSVgsT0FBRyxLQUFNLE1BQU0sSUFBSSxJQUFJLFlBQVksV0FBVyxPQUFPLE9BQVE7QUFBQTtBQUc5RCxNQUFJLEVBQUUsVUFBVSxTQUFTLE9BQU87QUFFaEMsTUFBSTtBQUdKLHVCQUFxQixZQUFtQztBQUN2RCxRQUFJLHFCQUFxQjtBQUN6QixRQUFJLGtCQUFrQjtBQUN0QixXQUFPLElBQUksUUFBYyxDQUFDLFNBQVMsV0FBVztBQUM3QyxZQUFNLFNBQVMsTUFBTTtBQUNwQixxQkFBYSxPQUFPLE9BQU8sTUFBTSxVQUFVLE1BQU07QUFDaEQsY0FBSSxDQUFDLGlCQUFpQjtBQUNyQixpQkFBSyxTQUFTLFNBQVMsSUFBSSxTQUFTLEVBQUUsYUFBYSxZQUFZLFFBQVE7QUFDdkUsaUJBQUssU0FBUyxTQUFTLElBQUksUUFBUSxFQUFFLE1BQU0sVUFBVSxZQUFZLE9BQU8sUUFBUTtBQUFBO0FBRWpGLDRCQUFrQjtBQUNsQjtBQUFBO0FBRUQsaURBQVksR0FBRyxTQUFTO0FBQUE7QUFHekIsWUFBTSxVQUFVLENBQUMsUUFBK0I7QUFDL0MsWUFBSSxJQUFJLFFBQVEsSUFBSSxTQUFTLGNBQWM7QUFDMUMsY0FBSSxDQUFDLG9CQUFvQjtBQUN4QixpQkFBSyxTQUFTLFNBQVMsSUFBSSxVQUFVLEVBQUU7QUFDdkMsaUNBQXFCO0FBQUE7QUFFdEI7QUFDQSxpQkFBTztBQUFBLGVBQ0Q7QUFDTixnQkFBTSxTQUFTLFNBQVMsSUFBSTtBQUM1QixtREFBWSxlQUFlLFNBQVM7QUFDcEMsaUJBQU87QUFBQTtBQUFBO0FBSVQ7QUFBQTtBQUFBO0FBS0YsUUFBTSxZQUFZO0FBRWxCLFNBQU87QUFBQSxJQUNOO0FBQUEsSUFDQTtBQUFBLElBQ0EsUUFBUTtBQUFBLElBQ1IsTUFBTSxZQUFZO0FBQ2pCLGlCQUFXO0FBQUE7QUFBQTtBQUFBOyIsCiAgIm5hbWVzIjogW10KfQo=
