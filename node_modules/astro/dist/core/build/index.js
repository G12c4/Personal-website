import fs from "fs";
import * as colors from "kleur/colors";
import { polyfill } from "@astropub/webapi";
import { performance } from "perf_hooks";
import vite from "../vite.js";
import { createVite } from "../create-vite.js";
import { debug, defaultLogOptions, info, levels, timerMessage, warn } from "../logger.js";
import { createRouteManifest } from "../ssr/routing.js";
import { generateSitemap } from "../ssr/sitemap.js";
import { collectPagesData } from "./page-data.js";
import { build as scanBasedBuild } from "./scan-based-build.js";
import { staticBuild } from "./static-build.js";
async function build(config, options = { logging: defaultLogOptions }) {
  polyfill(globalThis, {
    exclude: "window document"
  });
  const builder = new AstroBuilder(config, options);
  await builder.build();
}
class AstroBuilder {
  constructor(config, options) {
    this.mode = "production";
    this.routeCache = {};
    if (!config.buildOptions.site && config.buildOptions.sitemap !== false) {
      warn(options.logging, "config", `Set "buildOptions.site" to generate correct canonical URLs and sitemap`);
    }
    if (options.mode)
      this.mode = options.mode;
    this.config = config;
    const port = config.devOptions.port;
    this.logging = options.logging;
    this.origin = config.buildOptions.site ? new URL(config.buildOptions.site).origin : `http://localhost:${port}`;
    this.manifest = createRouteManifest({ config }, this.logging);
  }
  async build() {
    const { logging, origin } = this;
    const timer = {};
    timer.init = performance.now();
    timer.viteStart = performance.now();
    const viteConfig = await createVite(vite.mergeConfig({
      mode: this.mode,
      server: {
        hmr: { overlay: false },
        middlewareMode: "ssr"
      }
    }, this.config.vite || {}), { astroConfig: this.config, logging });
    this.viteConfig = viteConfig;
    const viteServer = await vite.createServer(viteConfig);
    this.viteServer = viteServer;
    debug(logging, "build", timerMessage("Vite started", timer.viteStart));
    timer.loadStart = performance.now();
    const { assets, allPages } = await collectPagesData({
      astroConfig: this.config,
      logging: this.logging,
      manifest: this.manifest,
      origin,
      routeCache: this.routeCache,
      viteServer: this.viteServer
    });
    Object.entries(allPages).forEach(([page, data]) => {
      if ("frontmatter" in data.preload[1]) {
        const frontmatter = data.preload[1].frontmatter;
        if (Boolean(frontmatter.draft) && !this.config.buildOptions.drafts) {
          debug(logging, "build", timerMessage(`Skipping draft page ${page}`, timer.loadStart));
          delete allPages[page];
        }
      }
    });
    debug(logging, "build", timerMessage("All pages loaded", timer.loadStart));
    const pageNames = [];
    timer.buildStart = performance.now();
    if (this.config.buildOptions.experimentalStaticBuild) {
      await staticBuild({
        allPages,
        astroConfig: this.config,
        logging: this.logging,
        origin: this.origin,
        pageNames,
        routeCache: this.routeCache,
        viteConfig: this.viteConfig
      });
    } else {
      await scanBasedBuild({
        allPages,
        astroConfig: this.config,
        logging: this.logging,
        origin: this.origin,
        pageNames,
        routeCache: this.routeCache,
        viteConfig: this.viteConfig,
        viteServer: this.viteServer
      });
    }
    debug(logging, "build", timerMessage("Vite build finished", timer.buildStart));
    timer.assetsStart = performance.now();
    Object.keys(assets).map((k) => {
      if (!assets[k])
        return;
      const filePath = new URL(`file://${k}`);
      fs.mkdirSync(new URL("./", filePath), { recursive: true });
      fs.writeFileSync(filePath, assets[k], "utf8");
      delete assets[k];
    });
    debug(logging, "build", timerMessage("Additional assets copied", timer.assetsStart));
    timer.sitemapStart = performance.now();
    if (this.config.buildOptions.sitemap && this.config.buildOptions.site) {
      const sitemap = generateSitemap(pageNames.map((pageName) => new URL(pageName, this.config.buildOptions.site).href));
      const sitemapPath = new URL("./sitemap.xml", this.config.dist);
      await fs.promises.mkdir(new URL("./", sitemapPath), { recursive: true });
      await fs.promises.writeFile(sitemapPath, sitemap, "utf8");
    }
    debug(logging, "build", timerMessage("Sitemap built", timer.sitemapStart));
    await viteServer.close();
    if (logging.level && levels[logging.level] <= levels["info"]) {
      await this.printStats({ logging, timeStart: timer.init, pageCount: pageNames.length });
    }
  }
  async printStats({ logging, timeStart, pageCount }) {
    debug(logging, "");
    const buildTime = performance.now() - timeStart;
    const total = buildTime < 750 ? `${Math.round(buildTime)}ms` : `${(buildTime / 1e3).toFixed(2)}s`;
    const perPage = `${Math.round(buildTime / pageCount)}ms`;
    info(logging, "build", `${pageCount} pages built in ${colors.bold(total)} ${colors.dim(`(${perPage}/page)`)}`);
    info(logging, "build", `\u{1F680} ${colors.cyan(colors.bold("Done"))}`);
  }
}
export {
  build as default
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vc3JjL2NvcmUvYnVpbGQvaW5kZXgudHMiXSwKICAibWFwcGluZ3MiOiAiQUFHQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFRQSxxQkFBb0MsUUFBcUIsVUFBd0IsRUFBRSxTQUFTLHFCQUFvQztBQUUvSCxXQUFTLFlBQVk7QUFBQSxJQUNwQixTQUFTO0FBQUE7QUFHVixRQUFNLFVBQVUsSUFBSSxhQUFhLFFBQVE7QUFDekMsUUFBTSxRQUFRO0FBQUE7QUFHZixtQkFBbUI7QUFBQSxFQVVsQixZQUFZLFFBQXFCLFNBQXVCO0FBUGhELGdCQUFPO0FBRVAsc0JBQXlCO0FBTWhDLFFBQUksQ0FBQyxPQUFPLGFBQWEsUUFBUSxPQUFPLGFBQWEsWUFBWSxPQUFPO0FBQ3ZFLFdBQUssUUFBUSxTQUFTLFVBQVU7QUFBQTtBQUdqQyxRQUFJLFFBQVE7QUFBTSxXQUFLLE9BQU8sUUFBUTtBQUN0QyxTQUFLLFNBQVM7QUFDZCxVQUFNLE9BQU8sT0FBTyxXQUFXO0FBQy9CLFNBQUssVUFBVSxRQUFRO0FBQ3ZCLFNBQUssU0FBUyxPQUFPLGFBQWEsT0FBTyxJQUFJLElBQUksT0FBTyxhQUFhLE1BQU0sU0FBUyxvQkFBb0I7QUFDeEcsU0FBSyxXQUFXLG9CQUFvQixFQUFFLFVBQVUsS0FBSztBQUFBO0FBQUEsUUFHaEQsUUFBUTtBQUNiLFVBQU0sRUFBRSxTQUFTLFdBQVc7QUFDNUIsVUFBTSxRQUFnQztBQUN0QyxVQUFNLE9BQU8sWUFBWTtBQUN6QixVQUFNLFlBQVksWUFBWTtBQUM5QixVQUFNLGFBQWEsTUFBTSxXQUN4QixLQUFLLFlBQ0o7QUFBQSxNQUNDLE1BQU0sS0FBSztBQUFBLE1BQ1gsUUFBUTtBQUFBLFFBQ1AsS0FBSyxFQUFFLFNBQVM7QUFBQSxRQUNoQixnQkFBZ0I7QUFBQTtBQUFBLE9BR2xCLEtBQUssT0FBTyxRQUFRLEtBRXJCLEVBQUUsYUFBYSxLQUFLLFFBQVE7QUFFN0IsU0FBSyxhQUFhO0FBQ2xCLFVBQU0sYUFBYSxNQUFNLEtBQUssYUFBYTtBQUMzQyxTQUFLLGFBQWE7QUFDbEIsVUFBTSxTQUFTLFNBQVMsYUFBYSxnQkFBZ0IsTUFBTTtBQUUzRCxVQUFNLFlBQVksWUFBWTtBQUM5QixVQUFNLEVBQUUsUUFBUSxhQUFhLE1BQU0saUJBQWlCO0FBQUEsTUFDbkQsYUFBYSxLQUFLO0FBQUEsTUFDbEIsU0FBUyxLQUFLO0FBQUEsTUFDZCxVQUFVLEtBQUs7QUFBQSxNQUNmO0FBQUEsTUFDQSxZQUFZLEtBQUs7QUFBQSxNQUNqQixZQUFZLEtBQUs7QUFBQTtBQUlsQixXQUFPLFFBQVEsVUFBVSxRQUFRLENBQUMsQ0FBQyxNQUFNLFVBQVU7QUFDbEQsVUFBSSxpQkFBaUIsS0FBSyxRQUFRLElBQUk7QUFFckMsY0FBTSxjQUFlLEtBQUssUUFBUSxHQUFXO0FBQzdDLFlBQUksUUFBUSxZQUFZLFVBQVUsQ0FBQyxLQUFLLE9BQU8sYUFBYSxRQUFRO0FBQ25FLGdCQUFNLFNBQVMsU0FBUyxhQUFhLHVCQUF1QixRQUFRLE1BQU07QUFDMUUsaUJBQU8sU0FBUztBQUFBO0FBQUE7QUFBQTtBQUtuQixVQUFNLFNBQVMsU0FBUyxhQUFhLG9CQUFvQixNQUFNO0FBRy9ELFVBQU0sWUFBc0I7QUFJNUIsVUFBTSxhQUFhLFlBQVk7QUFHL0IsUUFBSSxLQUFLLE9BQU8sYUFBYSx5QkFBeUI7QUFDckQsWUFBTSxZQUFZO0FBQUEsUUFDakI7QUFBQSxRQUNBLGFBQWEsS0FBSztBQUFBLFFBQ2xCLFNBQVMsS0FBSztBQUFBLFFBQ2QsUUFBUSxLQUFLO0FBQUEsUUFDYjtBQUFBLFFBQ0EsWUFBWSxLQUFLO0FBQUEsUUFDakIsWUFBWSxLQUFLO0FBQUE7QUFBQSxXQUVaO0FBQ04sWUFBTSxlQUFlO0FBQUEsUUFDcEI7QUFBQSxRQUNBLGFBQWEsS0FBSztBQUFBLFFBQ2xCLFNBQVMsS0FBSztBQUFBLFFBQ2QsUUFBUSxLQUFLO0FBQUEsUUFDYjtBQUFBLFFBQ0EsWUFBWSxLQUFLO0FBQUEsUUFDakIsWUFBWSxLQUFLO0FBQUEsUUFDakIsWUFBWSxLQUFLO0FBQUE7QUFBQTtBQUduQixVQUFNLFNBQVMsU0FBUyxhQUFhLHVCQUF1QixNQUFNO0FBR2xFLFVBQU0sY0FBYyxZQUFZO0FBQ2hDLFdBQU8sS0FBSyxRQUFRLElBQUksQ0FBQyxNQUFNO0FBQzlCLFVBQUksQ0FBQyxPQUFPO0FBQUk7QUFDaEIsWUFBTSxXQUFXLElBQUksSUFBSSxVQUFVO0FBQ25DLFNBQUcsVUFBVSxJQUFJLElBQUksTUFBTSxXQUFXLEVBQUUsV0FBVztBQUNuRCxTQUFHLGNBQWMsVUFBVSxPQUFPLElBQUk7QUFDdEMsYUFBTyxPQUFPO0FBQUE7QUFFZixVQUFNLFNBQVMsU0FBUyxhQUFhLDRCQUE0QixNQUFNO0FBR3ZFLFVBQU0sZUFBZSxZQUFZO0FBQ2pDLFFBQUksS0FBSyxPQUFPLGFBQWEsV0FBVyxLQUFLLE9BQU8sYUFBYSxNQUFNO0FBQ3RFLFlBQU0sVUFBVSxnQkFBZ0IsVUFBVSxJQUFJLENBQUMsYUFBYSxJQUFJLElBQUksVUFBVSxLQUFLLE9BQU8sYUFBYSxNQUFNO0FBQzdHLFlBQU0sY0FBYyxJQUFJLElBQUksaUJBQWlCLEtBQUssT0FBTztBQUN6RCxZQUFNLEdBQUcsU0FBUyxNQUFNLElBQUksSUFBSSxNQUFNLGNBQWMsRUFBRSxXQUFXO0FBQ2pFLFlBQU0sR0FBRyxTQUFTLFVBQVUsYUFBYSxTQUFTO0FBQUE7QUFFbkQsVUFBTSxTQUFTLFNBQVMsYUFBYSxpQkFBaUIsTUFBTTtBQUc1RCxVQUFNLFdBQVc7QUFDakIsUUFBSSxRQUFRLFNBQVMsT0FBTyxRQUFRLFVBQVUsT0FBTyxTQUFTO0FBQzdELFlBQU0sS0FBSyxXQUFXLEVBQUUsU0FBUyxXQUFXLE1BQU0sTUFBTSxXQUFXLFVBQVU7QUFBQTtBQUFBO0FBQUEsUUFLakUsV0FBVyxFQUFFLFNBQVMsV0FBVyxhQUE0RTtBQUUxSCxVQUFNLFNBQVM7QUFDZixVQUFNLFlBQVksWUFBWSxRQUFRO0FBQ3RDLFVBQU0sUUFBUSxZQUFZLE1BQU0sR0FBRyxLQUFLLE1BQU0saUJBQWlCLEdBQUksYUFBWSxLQUFNLFFBQVE7QUFDN0YsVUFBTSxVQUFVLEdBQUcsS0FBSyxNQUFNLFlBQVk7QUFDMUMsU0FBSyxTQUFTLFNBQVMsR0FBRyw0QkFBNEIsT0FBTyxLQUFLLFVBQVUsT0FBTyxJQUFJLElBQUk7QUFDM0YsU0FBSyxTQUFTLFNBQVMsYUFBTSxPQUFPLEtBQUssT0FBTyxLQUFLO0FBQUE7QUFBQTsiLAogICJuYW1lcyI6IFtdCn0K
